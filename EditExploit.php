<?php
/***
 *
 */
require_once('credentials.php');
require_once('classes/helper/Dbhelper.php');
require_once ('classes/other/geshi/geshi.php');


require_once('classes/Exploit.php');
require_once('classes/pExploit.php');
require ('classes/Platform.php');
require ('classes/pPlatform.php');

require_once 'classes/Category.php';
require_once 'classes/pCategory.php';
/**Passwörter*/
require_once 'classes/other/phpass-0.3/PasswordHash.php';
require_once 'classes/helper/Login.php';
require_once 'classes/helper/Session.php';
require_once 'classes/helper/Upload.php';
require_once 'classes/helper/Getvars.php';
require_once 'classes/helper/Formgen.php';

/***
 * @tutorial
 *
 * liste der Sprachen anlegen mit BASH
 * Liste
 * http://www.mediawiki.org/wiki/Extension:SyntaxHighlight_GeSHi/de#Unterst.C3.BCtzte_Sprachen
 * in eine textdatei speichern
 * cat lang   |while read LINE ; do  echo "'$LINE' =>'$LINE',">>esc; done
 *   ^ ausabe  ^umleiten an eine while scheife und in die datei esc schreiben
 *   oben $languages=array( und unten ); dranhängen - fertig:)
 */
$languages=array('text' =>'text','actionscript' =>'actionscript','ada' =>'ada','apache' =>'apache','applescript' =>'applescript','asm' =>'asm','asp' =>'asp','autoit' =>'autoit','bash' =>'bash',
'blitzbasic' =>'blitzbasic','bnf' =>'bnf','c' =>'c','caddcl' =>'caddcl','cadlisp' =>'cadlisp','cfdg' =>'cfdg','cfm' =>'cfm','cpp-qt' =>'cpp-qt','cpp' =>'cpp','csharp' =>'csharp','css-gen.cfg' =>'css-gen.cfg',
'css' =>'css','c_mac' =>'c_mac','d' =>'d','H' =>'H','delphi' =>'delphi','diff' =>'diff','div' =>'div','dos' =>'dos','eiffel' =>'eiffel','fortran' =>'fortran','freebasic' =>'freebasic',
'gml' =>'gml','groovy' =>'groovy','html4strict' =>'html4strict','idl' =>'idl','ini' =>'ini','inno' =>'inno','io' =>'io','java' =>'java','java5' =>'java5','javascript' =>'javascript','latex' =>'latex',
'lisp' =>'lisp','lua' =>'lua','matlab' =>'matlab','mirc' =>'mirc','mpasm' =>'mpasm','mysql' =>'mysql','nsis' =>'nsis','objc' =>'objc','ocaml-brief' =>'ocaml-brief','ocaml' =>'ocaml',
'oobas' =>'oobas','oracle8' =>'oracle8','pascal' =>'pascal','perl' =>'perl','php-brief' =>'php-brief','php' =>'php','plsql' =>'plsql','python' =>'python','qbasic' =>'qbasic',
'reg' =>'reg','robots' =>'robots','ruby' =>'ruby','sas' =>'sas','scheme' =>'scheme','sdlbasic' =>'sdlbasic','smalltalk' =>'smalltalk','smarty' =>'smarty','sql' =>'sql','tcl' =>'tcl',
'thinbasic' =>'thinbasic','tsql' =>'tsql','vb' =>'vb','vbnet' =>'vbnet','vhdl' =>'vhdl','visualfoxpro' =>'visualfoxpro','winbatch' =>'winbatch','xml' =>'xml',
'z80' =>'z80');

$dbh=new PDO(DB_DSN, DB_USR, DB_PASS);
$dbh->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_WARNING);		//@todo das steht nur zum üben hier
?>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>edit exploit</title>
<link rel="stylesheet" media="all" href="layout.css">
</head>
<body>
	<div id="head">
		<h1>edit exploit</h1>
		<!-- <img src="img/logo.png" alt="logo" /> -->
	</div>
	<div>
		<h2>edit exploit</h2>
		<?php
		$exploit =new pExploit();
		$exploit->dbh($dbh);
		//$exploit->mysqlSelect();
		$platform=new pPlatform();
		$platform->dbh($dbh);
		$category=new pCategory();
		$category->dbh($dbh);


		$vars= new Getvars();
		$vars->requireVar('catname');
		$vars->requireVar('category');
		$vars->requireVar('platform');
		$vars->requireVar('content');
		$vars->assignVar('url_upload');
		$vars->assignVar('pc_upload');
		$vars->assignVar('verified');
		$vars->requireVar('id');
		$vars->requireVar('edit');

		/*benutzereingaben auswerten*/
		if($vars->validateVars()){
			$fileSet=false;
			$e= new pExploit();
			$e->dbh($dbh);
			$e->mysqlSelect($vars->id());

			if ($e->file()!=='')
				$fileSet=true;		
			
			$e->autor('anonymous');
			$e->title($vars->catname());
			$e->category($vars->category());
			$e->platform($vars->platform());
			$e->content($vars->content());
			$e->codeLanguage($vars->language());
		
			$verified=false;
			if ($vars->verified()=='on')
			$verified=true;
			$e->verified($verified);
			$e->dbh($dbh);

			$upload=new Upload($vars->url_upload(),$_FILES['pc_upload']);
			$upload->uploaddir('upload');		
			$newfile=$upload->upload();
			if($newfile!="" && $fileSet){	
				echo "delete olde insert new";
				unlink($e->file());
			}
			$e->file($upload->upload());
			$e->mysqlUpdate();
			echo "<h4>{$vars->catname()} hinzugef&uuml;gt</h4>";
		}else {
		;
		}
		/**Formular erzeugen***/


		$edit=new Getvars();
		$edit->requireVar('edit');
		
		if ($edit->validateVars()){
			$e=new pExploit();
			$e->dbh($dbh);
			$e->mysqlSelect($edit->edit());
			
			echo $e->codeLanguage();
			
			$categories = array($e->category() =>$e->loadCategory()) + $category->mysqlSelect();
			$platforms=array($e->platform() =>$e->loadPlatform()) + $platform->mysqlSelect();
			$languages=array_merge(array($e->codeLanguage()), $languages);
			$path=pathinfo(__FILE__);
			
		
			$form=new Formgen("post", $path['filename'].'.'.$path['extension']);
			$form->addTextField("Name", "catname", $e->title());
			$form->addSelect("kategorie", "category",$categories);
			$form->addSelect("platform", "platform",$platforms);
			$form->addSelect("Spache", "language", $languages);
			$form->addTextArea("beschreibung", "content",$e->content(), 30,65);
			$form->addTextField("upload from url", "url_upload");
			$form->addUpload("upload from pc", "pc_upload");
			$form->addCheckBox("verified", "verified");
			$form->addHidden("id", $e->id());
			$form->addHidden("edit", $e->id());
			echo $form->getForm();
		}
		?>

	</div>
</body>
</html>
