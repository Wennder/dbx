<?php
/***
 *
 * @todo find list of geshi languages
 * @todo file upload
 */
require_once('credentials.php');
require_once('classes/helper/Dbhelper.php');
require_once ('classes/other/geshi/geshi.php');


require_once('classes/Exploit.php');
require_once('classes/pExploit.php');
require ('classes/Platform.php');
require ('classes/pPlatform.php');

require_once 'classes/Category.php';
require_once 'classes/pCategory.php';
/**Passwörter*/
require_once 'classes/other/phpass-0.3/PasswordHash.php';
require_once 'classes/helper/Login.php';
require_once 'classes/helper/Session.php';
require_once 'classes/helper/Upload.php';
require_once 'classes/helper/Getvars.php';
require_once 'classes/helper/Formgen.php';

$dbh=new PDO(DB_DSN, DB_USR, DB_PASS);
$dbh->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_WARNING);		//@todo das steht nur zum üben hier
?>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>add exploit</title>
<link rel="stylesheet" media="all" href="layout.css">
</head>
<body>
	<div id="head">
		<h1>add exploit</h1>
		<!-- <img src="img/logo.png" alt="logo" /> -->
	</div>
	<div>
		<h2>new exploit</h2>
		<?php
		$exploit =new pExploit();
		$exploit->dbh($dbh);
		//$exploit->mysqlSelect();
		$platform=new pPlatform();
		$platform->dbh($dbh);
		$category=new pCategory();
		$category->dbh($dbh);


		$vars= new Getvars();
		$vars->requireVar('catname');
		$vars->requireVar('category');
		$vars->requireVar('platform');
		$vars->requireVar('content');
		$vars->assignVar('url_upload');
		$vars->assignVar('pc_upload');
		$vars->assignVar('verified');


		/*benutzereingaben auswerten*/
		if($vars->validateVars()){

			$e= new pExploit();
			$e->autor('anonymous');
			$e->title($vars->catname());
			$e->category($vars->category());
			$e->platform($vars->platform());
			$e->content($vars->content());

			$verified=false;
			if ($vars->verified()=='on')
			$verified=true;
			$e->verified($verified);
			$e->dbh($dbh);

			$upload=new Upload($vars->url_upload(),$_FILES['pc_upload']);
			$upload->uploaddir('upload');
			$e->file($upload->upload());

			$e->mysqlInsert();
			echo "<h4>{$vars->catname()} hinzugef&uuml;gt</h4>";
		}else {
			//nicht alle erforderlichen Variablen dabei
			echo "<h5>missing stuff:</h5>";
			foreach ($vars->missingVars()as $missing){
				echo $missing. ", ";
			}
		}
		/**Formular erzeugen***/
		$path=pathinfo(__FILE__);
		$form=new Formgen("post", $path['filename']);
		$form->addTextField("Name", "catname");
		$form->addSelect("kategorie", "category",$category->mysqlSelect());
		$form->addSelect("platform", "platform",$platform->mysqlSelect());
		$form->addTextArea("beschreibung", "content","Beschreibung eingeben", 30,65);
		$form->addTextField("upload from url", "url_upload");
		$form->addUpload("upload from pc", "pc_upload");
		$form->addCheckBox("verified", "verified");
		echo $form->getForm();
		?>

	</div>
</body>
</html>
