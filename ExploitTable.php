<?php
require_once('credentials.php');
require_once('classes/helper/Dbhelper.php');
require_once ('classes/other/geshi/geshi.php');


require_once('classes/Exploit.php');
require_once('classes/pExploit.php');
require ('classes/Platform.php');
require ('classes/pPlatform.php');

require_once 'classes/Category.php';
require_once 'classes/pCategory.php';
/**Passwörter*/
require_once 'classes/other/phpass-0.3/PasswordHash.php';
require_once 'classes/helper/Login.php';

require_once 'classes/helper/Session.php';
require_once 'classes/helper/Upload.php';
require_once 'classes/helper/Getvars.php';
require_once 'classes/helper/Formgen.php';
require_once 'classes/helper/Navigation.php';
require_once 'classes/helper/Table.php';
require_once 'classes/helper/AntiHitFaker.php';

$dbh=new PDO(DB_DSN, DB_USR, DB_PASS);
$dbh->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_WARNING);		//@todo das steht nur zum üben hier
define('NUMBERS_PER_SIDE', 15);
/*
+----------------------------------+
| date   dL V	DESC hits platform |
|__#_____#__#_____#___#_____#______|
|__#_____#__#_____#___#_____#______|
|__#_____#__#_____#___#_____#______|
|__#_____#__#_____#___#_____#______|
|__#_____#__#_____#___#_____#______|
|__#_____#__#_____#___#_____#______|
|								   |
+----------------------------------+





*/
class ExploitTable{
	//for table
	private $tableUrl;
	private $formgen;
	private $htmlTable;
	private $rows=array();					//@todo: better name
	private $userVars;				
	
	
	private $detailsUrl;
	
	private $navigation;	
	private $representedObject;				//@todo: not implemented
	private $dbh;
	private $exploits=array();				//resultarray
		
	public function __construct($dbh){
		$this->formgen= new Formgen();
		$this->htmlTable= new HtmlTable();
		$this->navigation= new Navigation();
		$this->userVars=new Getvars();				
		$this->userVars->requireVar('id');		//id for db
		$this->dbh=$dbh; 
		
	}
	/**
	 * http://localhost/web/exploit/ViewByCategory.php?      order_by=hit  &order=desc &view=2
	 * done
	 * Generate the table heading inkluding links for order by...
	 */
	private function getHeading(){
		$vars=array('id'=>$this->userVars->id());
						
		$heading=array_keys($this->rows);
		foreach ($this->rows as $key =>$value){
			$order='asc';		
				
			if($this->userVars->order() && $this->userVars->order_by()==$key){				
				$this->userVars->order()=="asc"?$cursor="&#8593;" :  $cursor="&#8595;";
				$this->userVars->order()=="asc"?$order='desc' :  $order='asc';
				$text="$cursor $value";
			} else {
				$text=$value;
			}//fi

			$vars['order_by']=$key;
			$vars['order']=$order;
		
			$link= $this->formgen->getLink($text, $this->tableUrl, $vars);
			
			$this->htmlTable->addHeadingCell(new HtmlTableCell($link));
		}//each						
	}//getHeading
	
	public function getTable(){
		$retval=$this->getHeading();

		$ctr=0;
		foreach ($this->exploits as $e){
		$ctr%2==0? $ceil='table-gerade' :$ceil='table-ungerade';					
		$this->htmlTable->addRow($ceil);
			foreach ($this->rows as $key=>$value){

				
			$cell=$this->formgen->getLink($e->$key(), $this->detailsUrl, array('view' => $e->id()));
				
				$this->htmlTable->addDataCell(new HtmlTableCell($cell, "table_$key"));
				
				
				
			}#each
			$ctr++;
		}//each
		$retval= $this->htmlTable;
		return ''.$retval;	
	}
	
	
	public function loadBy(){
		if ($this->userVars->validateVars()){
			$e= new pExploit();
			
			$e->dbh($this->dbh);
			if($this->userVars->id()){
				$this->exploits=$e->mySqlSelectByCategory($this->userVars->id(), 0, 15);
				
				$this->navigation->nElements($e->mysqlCountByCategory($this->userVars->id()));
			
			}
			
		}
		
	}//loadBy
	
	/**
	 * required
	 * Url of tablesite
	 * @param string $tableUrl
	 */
	public function tableUrl($tableUrl=""){ if (empty($tableUrl)){return $this->tableUrl; }else{$this->tableUrl=$tableUrl; } }
	public function rows($rows=""){ if (empty($rows)){return $this->rows; }else{$this->rows=$rows; } }
	public function detailsUrl($detailsUrl=""){ if (empty($detailsUrl)){return $this->detailsUrl; }else{$this->detailsUrl=$detailsUrl; } }
}//class


$sitename=pathinfo(__FILE__);
$sitename=$sitename['basename'];


$et = new ExploitTable($dbh);
$et->tableUrl($sitename);
$et->detailsUrl('ViewExploit.php');

$et->loadBy();

			
$rows=array(	'date'			=>'date'
				,'file'			=>'dl'
				,'verified'		=>'v'
				,'content'		=>'Description'
				,'hits'			=>'hits'
				,'platform'		=>'platform'
				,'autor'		=>'autor'
				


			);			
			
$et->rows($rows);


/************
 * example 
 **********/
/*
$table=new HtmlTable('my_layout');
$table->addRow('gerade');
$table->addDataCell(new HtmlTableCell("spalteA1", HtmlTableCell::TABLE_HEADING));
$table->addDataCell(new HtmlTableCell("spalteA2", HtmlTableCell::TABLE_DATA));
$table->addDataCell(new HtmlTableCell("spalteA3", HtmlTableCell::TABLE_DATA));
$table->addDataCell(new HtmlTableCell("spalteA4", HtmlTableCell::TABLE_DATA));
$table->addDataCell(new HtmlTableCell("spalteA5", HtmlTableCell::TABLE_DATA));
$table->addRow('ungerade');
$table->addDataCell(new HtmlTableCell("spalteB1"));
$table->addDataCell(new HtmlTableCell("spalteB2", HtmlTableCell::TABLE_DATA));
$table->addDataCell(new HtmlTableCell("spalteB3", HtmlTableCell::TABLE_DATA));
$table->addDataCell(new HtmlTableCell("spalteB4", HtmlTableCell::TABLE_DATA));
$table->addDataCell(new HtmlTableCell("spalteB5", HtmlTableCell::TABLE_DATA));

$table->addHeadingCell(new HtmlTableCell("Bereich 1", 'heading1'));
$table->addHeadingCell(new HtmlTableCell("Bereich 2", 'heading2'));
$table->addHeadingCell(new HtmlTableCell("Bereich 3"));
$table->addHeadingCell(new HtmlTableCell("Bereich 4"));
$table->addHeadingCell(new HtmlTableCell("Bereich 5"));

echo $table;
*/

?>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ue-cr3w exploits view by category</title>
<link rel="stylesheet" media="all" href="layout.css">
</head>
<body>
	<div id="head">
		<h1>
			<a href="index.php">ue-cr3w exploits</a>
		</h1>
		<img src="img/logo.png" alt="logo" />
	</div>
	<div>
	
	<?php  echo $et->getTable(); ?>
	
	</div>
	
</body>
</html>
